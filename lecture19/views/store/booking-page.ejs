<%- include('../partials/head') %>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  </head>
  <body>
    <%- include('../partials/nav') %>
    <main class="container mx-auto bg-white shadow-lg rounded-lg p-8 mt-10 max-w-3xl">
      <div class="flex flex-col md:flex-row gap-8">
        <!-- Home Info Section -->
        <div class="md:w-1/3">
          <img src="<%= home.photoUrl %>" alt="<%= home.houseName %>" class="w-full h-48 object-cover rounded-lg mb-4">
          <h2 class="text-2xl font-bold text-gray-800 mb-2"><%= home.houseName %></h2>
          <p class="text-gray-600 mb-2"><i class="fas fa-map-marker-alt mr-2"></i><%= home.location %></p>
          <p class="text-xl font-bold text-red-500 mb-4">₹<%= home.price %> / night</p>
          <div class="flex items-center mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-yellow-400 mr-1">
              <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd" />
            </svg>
            <span class="text-gray-700"><%= home.rating %></span>
          </div>
        </div>

        <!-- Booking Form Section -->
        <div class="md:w-2/3">
          <h3 class="text-2xl font-bold text-red-500 mb-6">Book Your Stay</h3>
          <form action="/book-home/<%= home._id %>" method="POST" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-gray-700 mb-2" for="checkIn">Check-in Date</label>
                <input type="text" id="checkIn" name="checkIn" class="w-full p-2 border rounded-md" required>
              </div>
              <div>
                <label class="block text-gray-700 mb-2" for="checkOut">Check-out Date</label>
                <input type="text" id="checkOut" name="checkOut" class="w-full p-2 border rounded-md" required>
              </div>
            </div>

            <div>
              <label class="block text-gray-700 mb-2" for="guests">Number of Guests</label>
              <input type="number" id="guests" name="numberOfGuests" min="1" max="10" class="w-full p-2 border rounded-md" required>
            </div>

            <div>
              <label class="block text-gray-700 mb-2">Payment Method</label>
              <div class="grid grid-cols-1 gap-4">
                <!-- UPI Option -->
                <div class="border rounded-md p-4">
                  <label class="flex items-center cursor-pointer mb-4">
                    <input type="radio" name="paymentMethod" value="upi" class="mr-2" required>
                    <span class="flex items-center gap-2">
                      <i class="fas fa-qrcode text-blue-500 text-xl"></i>
                      UPI Payment
                    </span>
                  </label>
                  <div class="upi-details hidden pl-6">
                    <p class="text-sm text-gray-600">You will be redirected to select your preferred UPI app after confirming your booking.</p>
                  </div>
                </div>

                <!-- Credit Card Option -->
                <div class="border rounded-md p-4">
                  <label class="flex items-center cursor-pointer mb-4">
                    <input type="radio" name="paymentMethod" value="credit_card" class="mr-2">
                    <span class="flex items-center gap-2">
                      <i class="fas fa-credit-card text-green-500 text-xl"></i>
                      Credit Card
                    </span>
                  </label>
                  <div class="credit-card-details hidden pl-6 space-y-3">
                    <div>
                      <label class="block text-gray-700 text-sm mb-1" for="ccNumber">Card Number</label>
                      <input type="text" id="ccNumber" name="ccNumber" pattern="[0-9]{16}" maxlength="16" placeholder="1234 5678 9012 3456" class="w-full p-2 border rounded-md">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="block text-gray-700 text-sm mb-1" for="ccExpiry">Expiry (MM/YY)</label>
                        <input type="text" id="ccExpiry" name="ccExpiry" pattern="(0[1-9]|1[0-2])\/([0-9]{2})" placeholder="MM/YY" maxlength="5" class="w-full p-2 border rounded-md">
                      </div>
                      <div>
                        <label class="block text-gray-700 text-sm mb-1" for="ccCvv">CVV</label>
                        <input type="text" id="ccCvv" name="ccCvv" pattern="[0-9]{3}" maxlength="3" placeholder="123" class="w-full p-2 border rounded-md">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Debit Card Option -->
                <div class="border rounded-md p-4">
                  <label class="flex items-center cursor-pointer mb-4">
                    <input type="radio" name="paymentMethod" value="debit_card" class="mr-2">
                    <span class="flex items-center gap-2">
                      <i class="far fa-credit-card text-purple-500 text-xl"></i>
                      Debit Card
                    </span>
                  </label>
                  <div class="debit-card-details hidden pl-6 space-y-3">
                    <div>
                      <label class="block text-gray-700 text-sm mb-1" for="dcNumber">Card Number</label>
                      <input type="text" id="dcNumber" name="dcNumber" pattern="[0-9]{16}" maxlength="16" placeholder="1234 5678 9012 3456" class="w-full p-2 border rounded-md">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="block text-gray-700 text-sm mb-1" for="dcExpiry">Expiry (MM/YY)</label>
                        <input type="text" id="dcExpiry" name="dcExpiry" pattern="(0[1-9]|1[0-2])\/([0-9]{2})" placeholder="MM/YY" maxlength="5" class="w-full p-2 border rounded-md">
                      </div>
                      <div>
                        <label class="block text-gray-700 text-sm mb-1" for="dcCvv">CVV</label>
                        <input type="text" id="dcCvv" name="dcCvv" pattern="[0-9]{3}" maxlength="3" placeholder="123" class="w-full p-2 border rounded-md">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="border-t pt-4">
              <div class="flex justify-between mb-2">
                <span>₹<%= home.price %> × <span id="numberOfNights">0</span> nights</span>
                <span id="totalAmount">₹0</span>
              </div>
              <input type="hidden" name="totalPrice" id="totalPrice" value="0">
              <button type="submit" class="w-full bg-red-500 text-white py-3 rounded-md hover:bg-red-600 transition duration-300">
                Confirm Booking
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
      const price = <%= home.price %>;
      const checkInPicker = flatpickr("#checkIn", {
        minDate: "today",
        onChange: calculateTotal
      });
      const checkOutPicker = flatpickr("#checkOut", {
        minDate: "today",
        onChange: calculateTotal
      });

      function calculateTotal() {
        const checkIn = checkInPicker.selectedDates[0];
        const checkOut = checkOutPicker.selectedDates[0];
        
        if (checkIn && checkOut) {
          const nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
          const total = nights * price;
          
          document.getElementById('numberOfNights').textContent = nights;
          document.getElementById('totalAmount').textContent = `₹${total}`;
          document.getElementById('totalPrice').value = total;
        }
      }

      // Show/hide payment details based on selection
      document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
          // Hide all payment details first
          document.querySelectorAll('.upi-details, .credit-card-details, .debit-card-details').forEach(div => {
            div.classList.add('hidden');
          });
          
          // Show the selected payment method's details
          if (this.value === 'upi') {
            document.querySelector('.upi-details').classList.remove('hidden');
          } else if (this.value === 'credit_card') {
            document.querySelector('.credit-card-details').classList.remove('hidden');
          } else if (this.value === 'debit_card') {
            document.querySelector('.debit-card-details').classList.remove('hidden');
          }
        });
      });

      // Handle form submission
      document.querySelector('form').addEventListener('submit', function(e) {
        e.preventDefault();
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        
        if (paymentMethod === 'upi') {
          // Create booking first
          fetch(this.action, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams(new FormData(this))
          })
          .then(response => response.json())
          .then(data => {
            if (data.bookingId) {
              // Redirect to UPI payment page with booking ID
              const amount = document.getElementById('totalPrice').value;
              window.location.href = `/payment/upi?amount=${amount}&bookingId=${data.bookingId}`;
            } else {
              alert('Error creating booking. Please try again.');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error creating booking. Please try again.');
          });
        } else {
          // Submit form normally for other payment methods
          this.submit();
        }
      });

      // Format card expiry date input
      function formatExpiryDate(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length >= 2) {
          value = value.slice(0, 2) + '/' + value.slice(2);
        }
        input.value = value;
      }

      // Add event listeners for expiry date formatting
      document.querySelectorAll('#ccExpiry, #dcExpiry').forEach(input => {
        input.addEventListener('input', function() {
          formatExpiryDate(this);
        });
      });
    </script>
  </body>
</html> 